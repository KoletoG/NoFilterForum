@using System.Web
@using Core.Constants
@using Core.Enums
@using Web.ViewModels
@using Web.ViewModels.Post
@using Web.ViewModels.Reply
@using Web.ViewModels.Report


@model IndexReplyViewModel
<script src="~/js/JSLikesDislikes.js" asp-append-version="true"> </script>
<body class="mainBG">
	<div class="container secondaryBG shadow p-3">
		@if (Model.Post.Username != UserConstants.DefaultUser.UserName)
		{
			<div class="row borderBottom">

				<div class="col-10 text-center align-content-center">

					<h4 class="fw-bold mainText">@Model.Post.Title</h4>
				</div>
				<div class="col-2 borderStart text-center pt-2 mb-2">
					<partial name="_RoleColor" model="new RoleViewModel(Model.Post.Role,Model.Post.UserId,Model.Post.Username,true, Model.Post.ImageUrl)" />
				</div>
			</div>
			<div class="row mt-3">
				<div class="col-10 borderEnd">

					<h6 class="text-break secondaryText">@Html.Raw(Model.Post.Content)</h6>
				</div>
				<div class="col-2 d-flex flex-column  align-content-center">

					@if (Model.CurrentUser.LikesPostRepliesIds.Contains(Model.Post.Id))
					{
						<div class="d-flex align-items-center justify-content-around g-2">

							<partial name="_LikeDislike" model="new LikeDislikeViewModel(Model.Post.Id,true,true,true)" />
							<h6 class="mainText" id="likesCount_id_@Model.Post.Id">@Model.Post.Likes</h6>
							<partial name="_LikeDislike" model="new LikeDislikeViewModel(Model.Post.Id,true,false,false)" />
						</div>
					}
					else if (Model.CurrentUser.DislikesPostRepliesIds.Contains(Model.Post.Id))
					{
						<div class="d-flex align-items-center justify-content-around g-2">

							<partial name="_LikeDislike" model="new LikeDislikeViewModel(Model.Post.Id,true,true,false)" />
							<h6 class="mainText" id="likesCount_id_@Model.Post.Id">@Model.Post.Likes</h6>
							<partial name="_LikeDislike" model="new LikeDislikeViewModel(Model.Post.Id,true,false,true)" />
						</div>
					}
					else
					{
						<div class="d-flex align-items-center justify-content-around g-2">

							<partial name="_LikeDislike" model="new LikeDislikeViewModel(Model.Post.Id,true,true,false)" />

							<h6 class="mainText" id="likesCount_id_@Model.Post.Id">@Model.Post.Likes</h6>

							<partial name="_LikeDislike" model="new LikeDislikeViewModel(Model.Post.Id,true,false,false)" />

						</div>
					}
					@if (Model.Post.Username == this.User!.Identity!.Name! || Model.IsAdmin)
					{
						<div class="align-self-center justify-content-center d-flex">
							<partial name="_DeletePost" model="new DeletePostViewModel(){PostId=Model.Post.Id}" />
						</div>
					}
					else
					{
						<div class="align-self-center justify-content-center d-flex">
							<partial name="_CreateReport" model="new CreateReportViewModel(true,Model.Post.Id,Model.Post.UserId)" />
						</div>
					}
				</div>
			</div>
			<div class="row">
				<div class="col-10 borderEnd">
					<h6 class="text-end mainText"><partial name="_ShowTime" model="new ShowTimeViewModel(Model.Post.DateCreated)" /></h6>
				</div>
			</div>
		}
		else
		{
			<h5 style="text-decoration:line-through">@Model.Post.Username</h5>
		}
		@{
			<div class="row mt-3 mb-3 borderTop borderBottom">
				<partial name="_CreateReply" model="new CreateReplyViewModel(){PostId=Model.Post.Id}" />
			</div>
			int count = Model.Replies.Count;
			bool isFirst = true;
			@for (int i = 0; i < count; i++)
			{
				var reply = Model.Replies[i];
				<div class="row  secondaryBG borderBottom @(isFirst ? "borderTop" : string.Empty)">
					<div class="col-2 align-content-center borderEnd text-center">
						<partial name="_RoleColor" model="new RoleViewModel(reply.Role,reply.UserId,reply.Username,true,reply.ImageUrl)" />
						<h6 class="mainText">Posts count: <span class="fst-italic secondaryText">@reply.PostCount</span></h6>
					</div>

					<div class="col-8 pt-2 pb-2 d-flex flex-column">

						<div class="d-flex justify-content-start align-items-center" style="min-height:60px">
							@if (reply.Id == Model.ReplyId)
							{
								<h6 id="idrep_@reply.Id" style="background-color:#B58B64;">@Html.Raw(reply.Content)</h6>
							}
							else
							{
								<h6 class="text-break secondaryText">@Html.Raw(reply.Content)</h6>

							}
						</div>
						<div class="d-flex justify-content-end">
							<h6 class="mainText"><partial name="_ShowTime" model="new ShowTimeViewModel(reply.DateCreated)" /></h6>

						</div>
						<div class="d-flex borderTop justify-content-start align-items-center pt-1" style="min-height:60px">

							<h6 class="mainText fst-italic text-break">@reply.Bio</h6>
						</div>
					</div>
					@if (reply.Username != UserConstants.DefaultUser.UserName)
					{
						// refactor these likes dislikes type shi
						<div class="col-2 borderStart pt-2 text-center flex-column d-flex">
							<h6 class="text-center fst-italic secondaryText flex-grow-0">#@(i + 1)</h6>
							<div class="flex-grow-1 align-content-center">
								@if (Model.CurrentUser.LikesPostRepliesIds.Contains(reply.Id))
								{
									<div class="d-flex justify-content-around align-items-center">
										<partial name="_LikeDislike" model="new LikeDislikeViewModel(reply.Id,false,true,true)" />
										<h6 id="likesCount_id_@reply.Id" class="mainText">@reply.Likes</h6>
										<partial name="_LikeDislike" model="new LikeDislikeViewModel(reply.Id,false,false,false)" />

									</div>
								}
								else if (Model.CurrentUser.DislikesPostRepliesIds.Contains(reply.Id))
								{
									<div class="d-flex justify-content-around align-items-center">
										<partial name="_LikeDislike" model="new LikeDislikeViewModel(reply.Id,false,true,false)" />
										<h6 id="likesCount_id_@reply.Id" class="mainText">@reply.Likes</h6>
										<partial name="_LikeDislike" model="new LikeDislikeViewModel(reply.Id,false,false,true)" />

									</div>
								}
								else
								{
									<div class="d-flex justify-content-around align-items-center">
										<partial name="_LikeDislike" model="new LikeDislikeViewModel(reply.Id,false,true,false)" />
										<h6 id="likesCount_id_@reply.Id" class="mainText">@reply.Likes</h6>
										<partial name="_LikeDislike" model="new LikeDislikeViewModel(reply.Id,false,false,false)" />

									</div>
								}
								@if (reply.Username == this.User!.Identity!.Name! || Model.IsAdmin)
								{
									<div class="align-self-center justify-content-center d-flex">
										<partial name="_DeleteReply" model="new DeleteReplyViewModel(){PostId=Model.Post.Id,ReplyId=reply.Id}" />
									</div>
								}
								else
								{
									<div class="align-self-center justify-content-center d-flex">
										<partial name="_CreateReport" model="new CreateReportViewModel(false,reply.Id,reply.UserId)" />
									</div>
								}
							</div>
						</div>
					}
					else
					{
						<h5 style="text-decoration:line-through">@reply.Username</h5>
					}
				</div>
				isFirst = false;
			}
			<br />
			@if (Model.Replies.Any())
			{
				<div class="row borderBottom borderTop mt-3 mb-3">
					<partial name="_CreateReply" model="new CreateReplyViewModel(){PostId=Model.Post.Id}" />
				</div>
			}

			<partial name="_Paging" model="new PagingViewModel(Model.Page,Model.TotalPages,Model.ReplyControllerName,Model.IndexName,string.Empty,Model.Post.Id)" />
		}


	</div>
</body>
@section Scripts {
	<partial name="_ValidationScriptsPartial" />
	<script>
		document.addEventListener("DOMContentLoaded", function() {
				var targetLabel = document.getElementById("idrep_@Model.ReplyId");
				if (targetLabel)
				{
					targetLabel.scrollIntoView({ behavior: "smooth", block: "start" });
				}
		});
	</script>
}